<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRecruit - Resume Analyzer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #333;
            margin: 0;
        }
        nav {
            display: flex;
            gap: 10px;
        }
        .nav-button {
            background: white;
            color: #007bff;
            border: 1px solid #007bff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .nav-button:hover {
            background: #f0f7ff;
        }
        .resume-upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .upload-area {
            border: 2px dashed #007bff;
            padding: 40px;
            margin: 20px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-area:hover {
            background-color: #f0f7ff;
        }
        .upload-area p {
            margin: 0;
            color: #666;
        }
        .upload-area .icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 10px;
        }
        .resume-analysis {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analysis-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
        }
        .score-section {
            text-align: center;
        }
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            margin: 20px auto;
        }
        .analysis-details {
            display: grid;
            gap: 20px;
        }
        .analysis-details h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .skill-tag {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }
        #recommendationsList, #mistakesList {
            list-style-type: none;
            padding: 0;
        }
        #recommendationsList li, #mistakesList li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        #recommendationsList li:before, #mistakesList li:before {
            content: "•";
            color: #007bff;
            position: absolute;
            left: 0;
        }
        #mistakesList li:before {
            color: #dc3545;
        }
        .mistake-item {
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #dc3545;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .suggestion-item {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #ffc107;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .keyword-match {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .parse-status {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .parse-status .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .parse-status .success {
            background-color: #28a745;
        }
        .parse-status .warning {
            background-color: #ffc107;
        }
        .parse-status .error {
            background-color: #dc3545;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            background: #f8f9fa;
        }
        .tab.active {
            background: white;
            border-color: #dee2e6;
            border-bottom-color: white;
            font-weight: 500;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .job-match-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 4px;
        }
        .job-title-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .button-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .button-primary:hover {
            background: #0056b3;
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status-message.success {
            background: #d4edda;
            color: #155724;
        }
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }
        input[type="file"] {
            display: none;
        }
        .auth-warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .login-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* Styles for notice elements */
        .notice {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 80%;
            transition: opacity 0.5s;
        }
        
        .notice.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .notice.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .notice.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Demo suggestion styles */
        .demo-suggestion {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .demo-suggestion button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Resume Analyzer</h1>
            <nav>
                <a href="jobs-dashboard.html" class="nav-button">Jobs Dashboard</a>
            </nav>
        </header>
        <div id="authWarning" class="auth-warning">
            <strong>Authentication Required</strong>
            <p>You need to log in to upload and analyze your resume.</p>
            <div style="margin-top: 10px">
                <button onclick="window.location.href='index.html'" class="login-button">Login</button>
                <button onclick="autoDemoLogin()" class="login-button" style="background-color: #6c757d;">Use Demo Account</button>
            </div>
        </div>

        <div id="mainContent">
            <div class="resume-upload-section">
                <h2>Upload Your Resume</h2>
                <p>Upload your resume to get AI-powered analysis and feedback</p>
                
                <input type="file" id="resumeFile" accept=".pdf,.jpg,.jpeg,.png">
                <div id="uploadArea" class="upload-area" onclick="document.getElementById('resumeFile').click()">
                    <div class="icon">📄</div>
                    <p>Click to upload or drag & drop your resume here</p>
                    <p>Supported formats: PDF, JPG, PNG</p>
                </div>
                
                <div style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                    <button id="loadDemoButton" class="button-primary" style="background-color: #28a745; display: none;">Load Demo Resume</button>
                    <button id="testUploadBtn" class="button-primary" style="background-color: #6c757d; font-size: 0.8em;">Test Upload</button>
                    <button id="analyzeExistingBtn" class="button-primary" style="background-color: #007bff; font-size: 0.9em;">Analyze Existing Resume</button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
            </div>

            <div id="resumeAnalysis" class="resume-analysis">
                <h2>Resume Analysis</h2>
                
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="overview">Overview</div>
                        <div class="tab" data-tab="mistakes">Mistakes & Suggestions</div>
                        <div class="tab" data-tab="keywords">Keyword Analysis</div>
                        <div class="tab" data-tab="jobmatch">Job Match</div>
                    </div>
                    
                    <div id="overview" class="tab-content active">
                <div class="analysis-content">
                    <div class="score-section">
                        <h3>ATS Score</h3>
                        <div class="score-circle" id="atsScore">0</div>
                                <div class="parse-status">
                                    <span class="indicator success" id="parseIndicator"></span>
                                    <span id="parseStatus">Resume parsed successfully</span>
                                </div>
                    </div>
                    <div class="analysis-details">
                        <div class="detail-section">
                            <h3>Contact Information</h3>
                            <div id="contactDetails"></div>
                        </div>
                        <div class="detail-section">
                            <h3>Education</h3>
                            <div id="educationDetails"></div>
                        </div>
                        <div class="detail-section">
                            <h3>Experience</h3>
                            <div id="experienceDetails"></div>
                        </div>
                        <div class="detail-section">
                            <h3>Skills</h3>
                            <div id="skillsList"></div>
                        </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mistakes" class="tab-content">
                        <h3>Resume Mistakes Detected</h3>
                        <div id="mistakesContainer">
                            <ul id="mistakesList"></ul>
                        </div>
                        
                        <h3>Improvement Suggestions</h3>
                        <div id="suggestionsContainer"></div>
                    </div>
                    
                    <div id="keywords" class="tab-content">
                        <h3>Keyword Analysis</h3>
                        <p>Here's how your resume aligns with common industry keywords:</p>
                        <div id="keywordsContainer"></div>
                        
                        <div class="detail-section">
                            <h3>Missing Keywords</h3>
                            <p>Consider adding these relevant keywords to improve your ATS score:</p>
                            <div id="missingKeywords"></div>
                        </div>
                    </div>
                    
                    <div id="jobmatch" class="tab-content">
                        <h3>Job Description Match</h3>
                        <p>Enter a job title or description to see how well your resume matches:</p>
                        
                        <input type="text" id="jobTitleInput" class="job-title-input" placeholder="e.g., Senior Software Engineer, Frontend Developer...">
                        <textarea id="jobDescriptionInput" class="form-control" rows="6" placeholder="Paste job description here..."></textarea>
                        <button id="analyzeJobMatchBtn" class="button-primary" style="margin-top: 10px;">Analyze Match</button>
                        
                        <div id="jobMatchResults" style="margin-top: 20px; display: none;">
                            <div class="score-circle" id="jobMatchScore" style="width: 100px; height: 100px; font-size: 28px; margin: 10px 0;">0%</div>
                            <div id="jobMatchDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamic API URL that works in both development and production
        const API_URL = (() => {
            const hostname = window.location.hostname;
            // Check if we're on localhost
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8000';
            }
            // In production, use the same origin but ensure proper protocol
            const protocol = window.location.protocol;
            // For custom domains or when hosted on same domain as backend
            return `${protocol}//${hostname}${window.location.port ? ':' + window.location.port : ''}`;
        })();
        
        console.log('Using API URL:', API_URL);
        let serverAvailable = false;
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkServer();
            checkAuth();
            initTabSystem();
            initJobMatchAnalysis();
            
            // Comment out the demo button event listener to disable it
            /*
            const demoButton = document.getElementById('loadDemoButton');
            if (demoButton) {
                demoButton.addEventListener('click', () => {
                    loadDemoResume();
                });
            }
            */
            
            // Hide the demo button
            const demoButton = document.getElementById('loadDemoButton');
            if (demoButton) {
                demoButton.style.display = 'none';
            }
        });
        
        // Check if server is running
        async function checkServer() {
            try {
                console.log('Checking server availability...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                try {
                const response = await fetch(`${API_URL}/api/database`, {
                    method: 'GET',
                        mode: 'no-cors', // Important for CORS preflight check
                    cache: 'no-cache',
                        signal: controller.signal
                });
                
                    clearTimeout(timeoutId);
                    console.log('Server appears to be running', response);
                serverAvailable = true;
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        console.error('Server check timed out');
                        serverAvailable = false;
                        throw new Error('Server check timed out after 5 seconds');
                    } else {
                        console.error('Server fetch check failed:', fetchError);
                        serverAvailable = false;
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.error('Server check failed:', error);
                serverAvailable = false;
                showError(`Warning: The analysis server appears to be offline (${error.message}). Some features may not work.`);
                throw error;
            }
        }
        
        // Setup event listeners
        document.getElementById('resumeFile').addEventListener('change', handleFileUpload);
        
        // Initialize drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f0f7ff';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
            const file = e.dataTransfer.files[0];
            if (isValidFileType(file)) {
                document.getElementById('resumeFile').files = e.dataTransfer.files;
                uploadResume(file);
            } else {
                showError('Please upload a PDF or image file');
            }
        });
        
        function initTabSystem() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function initJobMatchAnalysis() {
            const analyzeBtn = document.getElementById('analyzeJobMatchBtn');
            analyzeBtn.addEventListener('click', () => {
                const jobTitle = document.getElementById('jobTitleInput').value;
                const jobDescription = document.getElementById('jobDescriptionInput').value;
                
                if (!jobTitle && !jobDescription) {
                    showError('Please enter a job title or description to analyze');
                    return;
                }
                
                analyzeJobMatch(jobTitle, jobDescription);
            });
        }
        
        async function analyzeJobMatch(jobTitle, jobDescription) {
            showMessage('Analyzing job match...', false);
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('You are not logged in. Please log in to analyze job match.');
                }
                
                const response = await fetch(`${API_URL}/api/me/resume/job-match`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_title: jobTitle,
                        job_description: jobDescription
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to analyze job match. Please make sure you have uploaded a valid resume first.');
                }
                
                const matchData = await response.json();
                displayJobMatch(matchData);
                showSuccess('Job match analysis complete');
            } catch (error) {
                console.error('Job match error:', error);
                showError('Job match analysis failed: ' + error.message);
            }
        }
        
        function checkAuth() {
            // Check if token exists and is valid
            if (!isTokenValid()) {
                // If in development mode, auto-login as demo user
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    if (loginAsDemoUser()) {
                        document.getElementById('authWarning').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        fetchExistingAnalysis();
                        return;
                    }
                }
                
                // No valid token and not in dev mode
                document.getElementById('authWarning').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
            } else {
                // Valid token exists
                document.getElementById('authWarning').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchExistingAnalysis();
            }
        }
        
        function fetchExistingAnalysis() {
            fetch(`${API_URL}/api/me/resume/analyze`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch existing analysis: ${response.status}`);
                }
                return response.json();
            })
            .then(analysis => {
                if (analysis) {
                    displayAnalysis(analysis);
                }
            })
            .catch(error => {
                console.log('No existing resume analysis found:', error.message);
            });
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && isValidFileType(file)) {
                uploadResume(file);
            } else if (file) {
                showError('Please upload a PDF or image file');
            }
        }
        
        function isValidFileType(file) {
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            return file && validTypes.includes(file.type);
        }
        
        // Upload result handling function with CORS error recovery
        async function uploadResult(url, formData, token) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.open('POST', url);
                
                // Add authentication header if token is provided
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
                
                // Handle XHR load completion
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        console.log(`Upload XHR completed with status: ${xhr.status}, statusText: ${xhr.statusText}`);
                        
                        // Check for CORS or network errors (status 0)
                        if (xhr.status === 0) {
                            console.log(' XHR status 0 - likely CORS or network issue');
                            
                            // Log available response headers for debugging
                            try {
                                const headers = xhr.getAllResponseHeaders();
                                console.log(' Response headers:', headers);
                            } catch (e) {
                                console.log(' Failed to get response headers:', e);
                            }
                            
                            // Create a more specific error
                            reject(new Error('Network error - CORS issue or server unreachable'));
                            return;
                        }
                        
                        // Handle successful responses (200-299)
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                console.log('Error parsing response:', e);
                                // If can't parse JSON but status is good, still consider successful
                                resolve({ success: true, message: 'Upload successful' });
                            }
                            return;
                        }
                        
                        // Handle server errors with useful messages
                        if (xhr.status >= 500) {
                            reject(new Error(`Server error (${xhr.status}): The server encountered an error processing your request.`));
                            return;
                        }
                        
                        // Handle other errors
                        let message = `Error ${xhr.status}`;
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.detail || response.message) {
                                message += `: ${response.detail || response.message}`;
                            }
                        } catch (e) {
                            // If we can't parse the response, use status text
                            message += xhr.statusText ? `: ${xhr.statusText}` : '';
                        }
                        
                        reject(new Error(message));
                    }
                };
                
                // Handle network errors
                xhr.onerror = function(e) {
                    console.log(' XHR network error occurred', e);
                    reject(new Error('Network error: Unable to connect to the server'));
                };
                
                // Log progress for large uploads
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        console.log(` Upload progress: ${percentComplete}%`);
                    }
                };
                
                try {
                    xhr.send(formData);
                } catch (e) {
                    console.log('', e);
                    reject(new Error(`Error sending request: ${e.message}`));
                }
            });
        }
        
        // Main upload function with better error handling
        async function uploadResume(file, extractedText = null, parsedData = null) {
            // Clear any previous error messages first
            clearAllMessages();
            
            showMessage('Processing resume...', false);
            
            // Check authentication status first
            const token = localStorage.getItem('token');
            if (!isTokenValid()) {
                showError('You need to log in to upload and analyze your resume.');
                return;
            }
            
            // If server is not available, show error
            if (!serverAvailable) {
                showError('Server unavailable. Please try again later.');
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            // Add extracted text if available
            if (extractedText) {
                formData.append('extracted_text', extractedText);
            }
            
            // Show upload message
            showMessage('Uploading resume to server...', false);
            
            try {
                // Set up a timeout to prevent long-running requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30-second timeout
                
                // Use fetch API for upload
                const response = await fetch(`${API_URL}/api/me/resume/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData,
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                
                // Handle response
                if (!response.ok) {
                    // Handle authentication errors
                    if (response.status === 401) {
                        throw new Error('Authentication failed. Please try logging in again.');
                    }
                    
                    // Get detailed error message if possible
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail || errorData.message) {
                            errorMessage = errorData.detail || errorData.message;
                        }
                    } catch (e) {
                        // If we can't parse the response, use status text
                        console.error('Could not parse error response:', e);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                console.log('Upload successful:', result);
                showSuccess('Resume uploaded successfully');
                
                // Proceed with analysis
                try {
                    await analyzeResume();
                } catch (analysisError) {
                    console.error('Analysis error after successful upload:', analysisError);
                    showError(`Resume uploaded, but analysis failed: ${analysisError.message}. Please try again later.`);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                
                // Handle specific error types
                if (error.name === 'AbortError') {
                    showError('Upload timed out. Please try again or use a smaller file.');
                    return;
                }
                
                if (error.message.includes('Authentication') || error.message.includes('token')) {
                    showError('Authentication issue. Please log in again.');
                    return;
                }
                
                // For other errors
                showError(`Upload failed: ${error.message}`);
            }
        }
        
        async function analyzeResume() {
            showMessage('Analyzing your uploaded resume...', false);
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    // Auto login as demo user for convenience
                    loginAsDemoUser();
                    showMessage('Auto-logged in as demo user. Analyzing resume...', false);
                    setTimeout(() => analyzeResume(), 500); // Try again after auto-login
                    return;
                }
                
                console.log(`Attempting to fetch from: ${API_URL}/api/me/resume/analyze`);
                
                // Set up a timeout to prevent long-running requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30-second timeout
                
                // Use fetch with proper token handling
                const response = await fetch(`${API_URL}/api/me/resume/analyze`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Auto login as demo user for convenience when auth fails
                        loginAsDemoUser();
                        showWarning('Authentication failed. Auto-logged in as demo user. Trying again...');
                        setTimeout(() => analyzeResume(), 1000); // Try again after auto-login
                        return;
                    }
                    
                    if (response.status === 404) {
                        throw new Error('No resume found. Please upload a resume first.');
                    }
                    
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorObj = JSON.parse(errorText);
                        errorMessage = errorObj.detail || errorObj.message || `Error: ${response.status}`;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} - ${errorText || response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const analysisResult = await response.json();
                
                // Check if there's an error_info field (may be included in debug mode)
                if (analysisResult.error_info) {
                    console.warn('Server returned analysis with error info:', analysisResult.error_info);
                    showWarning(`Server processed with warnings: ${analysisResult.error_info.message}`);
                }
                
                displayAnalysis(analysisResult);
                showSuccess('Resume analyzed successfully');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Failed to analyze resume: ${error.message}. Please try again later.`);
            }
        }
        
        function displayAnalysis(analysis) {
            const analysisSection = document.getElementById('resumeAnalysis');
            analysisSection.style.display = 'block';
            
            // Display source information if available (real or demo)
            if (analysis.hasOwnProperty('is_demo')) {
                const isDemo = analysis.is_demo;
                let sourceMessage = '';
                
                if (isDemo) {
                    sourceMessage = '<div style="background-color: #fff3cd; padding: 8px; margin-bottom: 15px; border-radius: 4px; text-align: center;">Displaying <strong>demo resume data</strong>. Upload your resume for personalized analysis.</div>';
                } else {
                    const filename = analysis.filename || 'unknown';
                    sourceMessage = `<div style="background-color: #d4edda; padding: 8px; margin-bottom: 15px; border-radius: 4px; text-align: center;">Analyzing your uploaded resume: <strong>${filename}</strong></div>`;
                }
                
                // Add source message to the top of the analysis section
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'resume-source-info';
                sourceDiv.innerHTML = sourceMessage;
                
                // Insert at the top of the analysis section, after the heading
                const heading = analysisSection.querySelector('h2');
                if (heading && heading.nextSibling) {
                    analysisSection.insertBefore(sourceDiv, heading.nextSibling);
                } else {
                    analysisSection.appendChild(sourceDiv);
                }
            }
            
            // Display parse status if available
            if (analysis.parse_status) {
                const indicator = document.getElementById('parseIndicator');
                const statusText = document.getElementById('parseStatus');
                
                // Set indicator color based on parse confidence
                if (analysis.parse_status.success && analysis.parse_status.confidence > 0.7) {
                    indicator.className = 'indicator success';
                } else if (analysis.parse_status.success) {
                    indicator.className = 'indicator warning';
                } else {
                    indicator.className = 'indicator error';
                }
                
                statusText.textContent = analysis.parse_status.message || 'Resume parsed';
            }
            
            // Update ATS Score
            document.getElementById('atsScore').textContent = Math.round(analysis.ats_score * 100);
            
            // Map score to color (red to green)
            const score = analysis.ats_score;
            const hue = score * 120; // 0 is red, 120 is green
            document.getElementById('atsScore').style.background = `hsl(${hue}, 70%, 45%)`;
            
            // Update Contact Information
            const contactDetails = document.getElementById('contactDetails');
            contactDetails.innerHTML = `
                <p><strong>Name:</strong> ${analysis.contact_info.name || 'Not found'}</p>
                <p><strong>Email:</strong> ${analysis.contact_info.email || 'Not found'}</p>
                <p><strong>Phone:</strong> ${analysis.contact_info.phone || 'Not found'}</p>
                <p><strong>Location:</strong> ${analysis.contact_info.location || 'Not found'}</p>
            `;
            
            // Update Education
            const educationDetails = document.getElementById('educationDetails');
            if (analysis.education && analysis.education.length > 0) {
                educationDetails.innerHTML = analysis.education.map(edu => `
                    <div class="education-item">
                        <p><strong>${edu.degree || 'Degree not specified'}</strong></p>
                        <p>${edu.institution || 'Institution not specified'}</p>
                        <p class="date">${edu.date_range || ''}</p>
                    </div>
                `).join('');
            } else {
                educationDetails.innerHTML = '<p>No education information detected</p>';
            }
            
            // Update Experience
            const experienceDetails = document.getElementById('experienceDetails');
            if (analysis.experience && analysis.experience.length > 0) {
                experienceDetails.innerHTML = analysis.experience.map(exp => `
                    <div class="experience-item">
                        <p><strong>${exp.title || 'Title not specified'}</strong></p>
                        <p>${exp.company || 'Company not specified'}</p>
                        <p class="date">${exp.date_range || ''}</p>
                        <p>${exp.description || ''}</p>
                    </div>
                `).join('');
            } else {
                experienceDetails.innerHTML = '<p>No experience information detected</p>';
            }
            
            // Update Skills
            const skillsList = document.getElementById('skillsList');
            if (analysis.skills && analysis.skills.length > 0) {
                skillsList.innerHTML = analysis.skills.map(skill => 
                    `<span class="skill-tag">${skill}</span>`
                ).join('');
            } else {
                skillsList.innerHTML = '<p>No skills detected</p>';
            }
            
            // Display mistakes
            const mistakesContainer = document.getElementById('mistakesList');
            if (analysis.mistakes && analysis.mistakes.length > 0) {
                mistakesContainer.innerHTML = analysis.mistakes.map(mistake => `
                    <li>
                        <div class="mistake-item">
                            <strong>${mistake.description}</strong>
                            <p>${mistake.suggestion}</p>
                        </div>
                    </li>
                `).join('');
            } else {
                mistakesContainer.innerHTML = '<li>No significant mistakes detected in your resume</li>';
            }
            
            // Display improvement suggestions
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            if (analysis.improvement_suggestions && analysis.improvement_suggestions.length > 0) {
                suggestionsContainer.innerHTML = analysis.improvement_suggestions.map(suggestion => `
                    <div class="suggestion-item">
                        <h4>${suggestion.title}</h4>
                        <p>${suggestion.description}</p>
                    </div>
                `).join('');
            } else {
                suggestionsContainer.innerHTML = '<p>No specific suggestions at this time</p>';
            }
            
            // Display keyword analysis
            const keywordsContainer = document.getElementById('keywordsContainer');
            const missingKeywords = document.getElementById('missingKeywords');
            
            if (analysis.keyword_analysis) {
                if (analysis.keyword_analysis.present && analysis.keyword_analysis.present.length > 0) {
                    keywordsContainer.innerHTML = analysis.keyword_analysis.present.map(keyword => `
                        <div class="keyword-match">
                            <strong>${keyword.keyword}</strong> 
                            <span>(relevance: ${keyword.relevance}, mentions: ${keyword.count || 1})</span>
                        </div>
                    `).join('');
                } else {
                    keywordsContainer.innerHTML = '<p>No significant keywords detected</p>';
                }
                
                if (analysis.keyword_analysis.missing && analysis.keyword_analysis.missing.length > 0) {
                    missingKeywords.innerHTML = analysis.keyword_analysis.missing.map(keyword => 
                        `<span class="skill-tag" style="border: 1px dashed #dc3545">
                            ${keyword.keyword} ${keyword.relevance === 'high' ? '⭐' : ''}
                        </span>`
                    ).join('');
                } else {
                    missingKeywords.innerHTML = '<p>No missing keywords identified</p>';
                }
            } else {
                keywordsContainer.innerHTML = '<p>Keyword analysis not available</p>';
                missingKeywords.innerHTML = '<p>Missing keywords analysis not available</p>';
            }
            
            // Display any warnings
            if (analysis.warning) {
                showWarning(analysis.warning);
            }
        }
        
        function displayJobMatch(matchData) {
            const resultsContainer = document.getElementById('jobMatchResults');
            resultsContainer.style.display = 'block';
            
            // Update match score
            const matchScore = Math.round(matchData.match_percentage * 100);
            document.getElementById('jobMatchScore').textContent = `${matchScore}%`;
            
            // Color the score circle based on match percentage
            const hue = matchScore * 1.2; // 0-120 (red to green)
            document.getElementById('jobMatchScore').style.background = `hsl(${hue}, 70%, 45%)`;
            
            // Display match details
            const matchDetails = document.getElementById('jobMatchDetails');
            
            let matchingKeywordsHtml = '';
            if (matchData.matching_keywords && matchData.matching_keywords.length > 0) {
                matchingKeywordsHtml = `
                    <div class="detail-section">
                        <h4>Matching Keywords</h4>
                        <div>
                            ${matchData.matching_keywords.map(k => 
                                `<span class="skill-tag">${k.keyword} 
                                    ${k.importance === 'high' ? '⭐' : ''}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            let missingKeywordsHtml = '';
            if (matchData.missing_keywords && matchData.missing_keywords.length > 0) {
                missingKeywordsHtml = `
                    <div class="detail-section">
                        <h4>Missing Keywords</h4>
                        <div>
                            ${matchData.missing_keywords.map(k => 
                                `<span class="skill-tag" style="border: 1px dashed #dc3545">
                                    ${k.keyword} ${k.importance === 'high' ? '⭐' : ''}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            let suggestionsHtml = '';
            if (matchData.improvement_suggestions && matchData.improvement_suggestions.length > 0) {
                suggestionsHtml = `
                    <div class="detail-section">
                        <h4>Suggestions to Improve Match</h4>
                        <ul style="margin-left: 20px">
                            ${matchData.improvement_suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            matchDetails.innerHTML = `
                <div class="match-summary">
                    ${matchScore >= 70 
                        ? '<p>Your resume is a <strong>good match</strong> for this job!</p>' 
                        : '<p>Your resume could be <strong>improved</strong> to better match this job.</p>'}
                </div>
                ${matchingKeywordsHtml}
                ${missingKeywordsHtml}
                ${suggestionsHtml}
            `;
        }
        
        function showMessage(message, isError) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message';
            statusDiv.style.display = 'block';
            
            if (isError) {
                statusDiv.classList.add('error');
            } else {
                statusDiv.classList.add('success');
            }
        }
        
        function showSuccess(message) {
            showMessage(message, false);
        }
        
        function showError(message) {
            showMessage(message, true);
        }
        
        // Add function to clear all status messages
        function clearAllMessages() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
            statusDiv.style.display = 'none';
            
            // Remove any floating error notices
            const notices = document.querySelectorAll('.notice');
            notices.forEach(notice => {
                notice.remove();
            });
        }
        
        // Add warning message function (used in uploadResume)
        function showWarning(message) {
            showMessage(message, false);
            
            // Create a warning notice
            const warningElement = document.createElement('div');
            warningElement.className = 'notice warning';
            warningElement.textContent = message;
            document.body.appendChild(warningElement);
            
            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                if (document.body.contains(warningElement)) {
                    warningElement.style.opacity = '0';
                    setTimeout(() => {
                        if (document.body.contains(warningElement)) {
                            document.body.removeChild(warningElement);
                        }
                    }, 500);
                }
            }, 8000);
        }
        
        // Add token validation helper function
        function isTokenValid() {
            const token = localStorage.getItem('token');
            if (!token) return false;
            
            try {
                // Basic JWT validation (check expiration)
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expiry = payload.exp * 1000; // Convert to milliseconds
                const now = Date.now();
                
                if (now >= expiry) {
                    console.log('Token has expired');
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error('Error validating token:', e);
                return false;
            }
        }
        
        // Add login for demo user function
        function loginAsDemoUser() {
            console.log('Logging in as demo user');
            
            // Create a valid JWT token that will work with the backend SECRET_KEY
            // In a real app, this would come from the server
            const demoToken = createDemoToken();
            
            // Store demo user info
            localStorage.setItem('token', demoToken);
            localStorage.setItem('userType', 'student');
            localStorage.setItem('email', 'demo@example.com');
            localStorage.setItem('name', 'Demo User');
            
            console.log('Auto-logged in with demo account: demo@example.com');
            
            return true;
        }
        
        // Create a JWT token directly in the browser for demo purposes only
        function createDemoToken() {
            // Create header
            const header = {
                "alg": "HS256",
                "typ": "JWT"
            };
            
            // Create payload with long expiration (1 year from now)
            const now = Math.floor(Date.now() / 1000);
            const exp = now + (365 * 24 * 60 * 60); // 1 year in seconds
            
            const payload = {
                "sub": "demo@example.com",
                "exp": exp
            };
            
            // Encode header and payload
            const base64Header = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const base64Payload = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            // For demo purposes, we'll use a fixed signature that matches what the backend expects
            // In production, this would be computed using a secure hashing algorithm
            const signature = "demoTokenSignatureForTestingOnly12345";
            
            // Combine to form the token
            return `${base64Header}.${base64Payload}.${signature}`;
        }
        
        // Add test upload function
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for test upload button
            const testUploadBtn = document.getElementById('testUploadBtn');
            if (testUploadBtn) {
                testUploadBtn.addEventListener('click', function() {
                    // Check if we have a file selected
                    const fileInput = document.getElementById('resumeFile');
                    if (!fileInput.files || fileInput.files.length === 0) {
                        showError('Please select a file first');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    testUpload(file);
                });
            }
        });
        
        // Test upload function that uses the /api/test-upload endpoint
        async function testUpload(file) {
            showMessage('Testing file upload...', false);
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                console.log('Test uploading file:', file.name, 'size:', file.size, 'type:', file.type);
                
                // Test upload to the non-authenticated endpoint
                const response = await fetch(`${API_URL}/api/test-upload`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });
                
                // Check response
                if (response.ok) {
                    const result = await response.json();
                    console.log('Test upload successful:', result);
                    showSuccess(`Test upload successful! File: ${result.filename}, Size: ${result.size} bytes`);
                    
                    // Don't fall back to demo data - instead encourage proper upload
                    showMessage('Please log in and use the regular upload for resume analysis', false);
                } else {
                    // Try to get error details
                    let errorMessage = `Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ` - ${errorData.detail || errorData.message || response.statusText}`;
                    } catch (e) {
                        errorMessage += ` - ${response.statusText}`;
                    }
                    
                    console.error('Test upload failed:', errorMessage);
                    showError(`Test upload failed: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Test upload error:', error);
                showError(`Test upload error: ${error.message}`);
            }
        }

        // Add auto-login function for demo account
        function autoDemoLogin() {
            // Log as demo user
            loginAsDemoUser();
            
            // Update UI
            document.getElementById('authWarning').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Show success message
            showSuccess('Logged in as demo user. You can now upload and analyze resumes.');
            
            // Check for existing analysis
            fetchExistingAnalysis();
        }

        // Add event listener for the analyze existing resume button
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for analyze existing resume button
            const analyzeExistingBtn = document.getElementById('analyzeExistingBtn');
            if (analyzeExistingBtn) {
                analyzeExistingBtn.addEventListener('click', function() {
                    try {
                        analyzeResume();
                    } catch (error) {
                        console.error('Error analyzing existing resume:', error);
                        showError(`Error analyzing existing resume: ${error.message}`);
                    }
                });
            }
            
            // Add event listener for test upload button
            const testUploadBtn = document.getElementById('testUploadBtn');
            if (testUploadBtn) {
                testUploadBtn.addEventListener('click', function() {
                    // Check if we have a file selected
                    const fileInput = document.getElementById('resumeFile');
                    if (!fileInput.files || fileInput.files.length === 0) {
                        showError('Please select a file first');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    testUpload(file);
                });
            }
        });
    </script>
    <script src="navbar.js"></script>
</body>
</html>